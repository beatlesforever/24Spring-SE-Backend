<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房间信息</title>
    <link rel="stylesheet" href="home.css">
</head>
<body>
<header>
    <div class="logo">
    </div>
    <div class="user-info">
        <span class="room-number">房间号: <span id="roomId"></span></span>
        <span class="username">用户名: <span id="username"></span></span>
    </div>
    <nav>
        <ul>
            <li><a href="#">主页</a></li>
            <li><a href="#">设置</a></li>
            <li><a href="#">帮助</a></li>
        </ul>
    </nav>
</header>

<div class="room-status">
    <div class="current-info">
        <h1>房间信息</h1>
        <div id="currentInfo"></div>
    </div>
    <div class="energy-cost">
        <h2>能耗和费用</h2>
        <p>能量消耗: <span id="energyConsumed"></span> kWh</p>
        <p>总计消费: <span id="costAccumulated"></span> 元</p>
    </div>
</div>

<div class="controls">
    <div class="temperature-control">
        <h2>温度调节</h2>
        <input type="range" min="0" max="40" value="20" class="temperature-slider" id="temperatureSlider">
        <span class="target-temperature">目标温度: <span id="targetTemperatureDisplay">20</span> °C</span>
    </div>
    <div class="fan-speed-control">
        <h2>风速调节</h2>
        <button class="fan-speed-button" data-speed="低">低</button>
        <button class="fan-speed-button" data-speed="中">中</button>
        <button class="fan-speed-button" data-speed="高">高</button>
    </div>
    <div class="buttons">
        <button class="submit-button" id="submitButton">提交</button>
        <button class="reset-button" id="resetButton">重置</button>
    </div>
</div>

<footer>
    <p class="status-info">系统正常</p>
</footer>

<script>
    let initialRoomData;

    window.onload = function() {
        const roomId = localStorage.getItem('roomId');
        const username = localStorage.getItem('username');
        const token = localStorage.getItem('token');

        if (roomId && username && token) {
            document.getElementById('roomId').innerText = roomId;
            document.getElementById('username').innerText = username;
            initialRoomData = JSON.parse(localStorage.getItem('roomInfo'));
            displayRoomInfo(initialRoomData);
            setInterval(() => fetchRoomInfo(roomId, token), 1000000);
        }

        const temperatureSlider = document.getElementById('temperatureSlider');
        temperatureSlider.addEventListener('input', function() {
            document.getElementById('targetTemperatureDisplay').innerText = this.value;
        });

        const fanSpeedButtons = document.querySelectorAll('.fan-speed-button');
        fanSpeedButtons.forEach(button => {
            button.addEventListener('click', function() {
                fanSpeedButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });

        document.getElementById('submitButton').addEventListener('click', submitSettings);
        document.getElementById('resetButton').addEventListener('click', resetSettings);
    };

    function fetchRoomInfo(roomId, token) {
        fetch(`/api/rooms/${roomId}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "200 OK") {
                    displayRoomInfo(data.data);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while fetching room information.");
            });
    }

    function displayRoomInfo(roomData) {
        const fanSpeedMap = {
            'low': '低',
            'medium': '中',
            'high': '高'
        };
        const modeMap = {
            'cooling': '制冷',
            'heating': '制热'
        };
        const statusMap = {
            'on': '开',
            'off': '关',
            'standby': '待机'
        };

        document.getElementById('currentInfo').innerHTML = `
                <p>当前温度: ${roomData.currentTemperature} °C</p>
                <p>当前目标温度: ${roomData.targetTemperature} °C</p>
                <p>风速: ${fanSpeedMap[roomData.fanSpeed]}</p>
                <p>模式: ${modeMap[roomData.mode]}</p>
                <p>当前状态: ${statusMap[roomData.status]}</p>
            `;
        document.getElementById('energyConsumed').innerText = roomData.energyConsumed;
        document.getElementById('costAccumulated').innerText = roomData.costAccumulated;
        document.getElementById('temperatureSlider').value = roomData.targetTemperature;
        document.getElementById('targetTemperatureDisplay').innerText = roomData.targetTemperature;
        document.querySelector(`.fan-speed-button[data-speed="${fanSpeedMap[roomData.fanSpeed]}"]`).classList.add('active');
    }

    function submitSettings() {
        const targetTemperature = document.getElementById('temperatureSlider').value;
        const fanSpeedButton = document.querySelector('.fan-speed-button.active');
        const fanSpeed = fanSpeedButton ? fanSpeedButton.getAttribute('data-speed') : null;

        const settings = {
            targetTemperature: targetTemperature,
            fanSpeed: fanSpeed
        };

        const roomId = localStorage.getItem('roomId');
        const token = localStorage.getItem('token');
        fetch(`/api/rooms/${roomId}/settings`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "200 OK") {
                    alert('设置已提交');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while submitting settings.");
            });
    }

    function resetSettings() {
        if (initialRoomData) {
            displayRoomInfo(initialRoomData);
        }
    }
</script>
</body>
</html>
